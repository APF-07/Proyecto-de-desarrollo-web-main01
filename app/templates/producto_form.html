{% extends "base.html" %}
{% block content %}
<h4 class="mb-4">
  {% if producto %}Editar producto{% else %}Registrar nuevo producto{% endif %}
</h4>

<form method="POST" class="shadow-sm p-4 bg-white rounded" enctype="multipart/form-data" novalidate>
  <div class="row g-3">
    
    <div class="col-12 mb-4">
        <label class="form-label fw-bold">Imagen del Producto</label>
        <div class="d-flex gap-3 align-items-center p-3 border rounded bg-light">
            <div class="flex-grow-1">
                <input type="file" class="form-control" name="imagen" id="inputImagen" accept="image/*" 
                       onchange="previsualizarImagen(this)">
                <div class="form-text">Formatos permitidos: JPG, PNG, WEBP.</div>
            </div>

            <div class="text-center position-relative">
                <small class="d-block text-muted mb-1">Vista previa:</small>
                <img id="imgPreview" 
                     src="{{ url_for('static', filename='img/' + producto.imagen) if producto and producto.imagen else 'https://via.placeholder.com/80?text=Sin+Foto' }}" 
                     alt="Previsualización" 
                     class="rounded border shadow-sm bg-white object-fit-cover" 
                     style="width: 80px; height: 80px;">
            </div>
        </div>
    </div>

    <div class="col-12">
      <h6 class="text-muted mb-3 border-bottom pb-2">Información básica</h6>
    </div>

    <div class="col-md-6">
      <label class="form-label">Nombre del producto</label>
      <input
        type="text"
        class="form-control"
        name="nombre"
        placeholder="Ej. Quinua blanca"
        value="{{ producto.nombre if producto else '' }}"
        required
      >
    </div>

    <div class="col-md-3">
      <label class="form-label">Categoría</label>
      <select name="categoria" class="form-select" required>
        <option value="">-- Seleccionar --</option>
        {% for c in categorias %}
          <option value="{{ c.id }}"
            {% if producto and (producto.id_categoria == c.id or producto.id_categoria|string == c.id|string) %}selected{% endif %}>
            {{ c.nombre }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Proveedor</label>
      <select name="proveedor" class="form-select" required>
        <option value="">-- Seleccionar --</option>
        {% for p in proveedores %}
          <option value="{{ p.id }}"
            {% if producto and (producto.id_proveedor == p.id or producto.id_proveedor|string == p.id|string) %}selected{% endif %}>
            {{ p.nombre }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12 mt-4">
      <h6 class="text-muted mb-3 border-bottom pb-2">Precio y unidad de medida</h6>
    </div>

    <div class="col-md-4">
      <label class="form-label">Precio unitario (S/)</label>
      <input
        type="number"
        class="form-control"
        name="precio"
        step="0.1"
        min="0"
        placeholder="Ej. 14.7"
        value="{{ producto.precio if producto else '' }}"
        required
      >
      <div class="form-text">Un decimal (ej. 14.7 → S/14.70)</div>
    </div>

    <div class="col-md-8">
      <label class="form-label">Unidad de medida</label>
      <select name="unidad" class="form-select" required>
        <option value="">-- Seleccionar unidad --</option>
        {% set unidades = {
          'kg': 'Kilogramo (1,000 gramos)',
          'g': 'Gramo',
          'qq': 'Quintal (100 kg)',
          'arroba': 'Arroba (≈ 11.5 kg)',
          'saco': 'Saco estándar (≈ 50 kg)',
          'unidad': 'Unidad individual'
        } %}
        {% for clave, descripcion in unidades.items() %}
          <option value="{{ clave }}"
            {% if producto and producto.unidad == clave %}selected{% endif %}>
            {{ clave | upper }} - {{ descripcion }}
          </option>
        {% endfor %}
      </select>
      <div class="form-text">Unidad comercial utilizada para el producto</div>
    </div>

    <div class="col-12 mt-4">
      <h6 class="text-muted mb-3 border-bottom pb-2">Gestión de stock</h6>
    </div>

    {% if not producto %}
    <div class="col-md-4">
      <label class="form-label">Stock inicial</label>
      <input
        type="number"
        class="form-control"
        name="stock_inicial"
        step="1"
        min="0"
        placeholder="Ej. 100"
        value="{{ request.form.stock_inicial if request.form.stock_inicial else '' }}"
        required
      >
      <div class="form-text">Cantidad inicial en inventario</div>
    </div>
    {% endif %}

    {% if producto %}
    <div class="col-md-4">
      <label class="form-label">Stock actual</label>
      <input
        type="number"
        class="form-control"
        name="stock_actual"
        step="1"
        min="0"
        value="{{ producto.stock | int if producto.stock is not none else 0 }}"
        readonly
      >
      <div class="form-text">Solo lectura (no editable)</div>
    </div>
    {% endif %}

    <div class="col-md-4">
      <label class="form-label">Stock mínimo</label>
      <input
        type="number"
        class="form-control"
        name="stock_minimo"
        step="1"
        min="0"
        placeholder="Ej. 20"
        value="{{ producto.stock_minimo if producto else '' }}"
        required
      >
      <div class="form-text">Alerta cuando esté por debajo</div>
    </div>

    <div class="col-12 mt-4 pt-3 border-top text-end">
      <a href="{{ url_for('main.listar_productos') }}" class="btn btn-secondary">
        <i class="bi bi-x-circle"></i>
        Cancelar
      </a>
      <button type="submit" class="btn btn-success">
        <i class="bi bi-check-circle"></i>
        {% if producto %}Actualizar producto{% else %}Guardar producto{% endif %}
      </button>
    </div>

  </div>
</form>

<script>
function previsualizarImagen(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        
        reader.onload = function(e) {
            // Cambiamos el src de la imagen por el archivo seleccionado
            document.getElementById('imgPreview').src = e.target.result;
        }
        
        reader.readAsDataURL(input.files[0]); // Leemos el archivo
    }
}
</script>
{% endblock %}